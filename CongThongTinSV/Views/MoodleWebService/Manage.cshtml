@using Kendo.Mvc.UI;
@using CongThongTinSV.Models;
@{
    ViewBag.Title = "Quản lý dịch vụ web của moodle";
}

@(Html.Kendo().Grid<MoodleWebService>()
    .Name("Grid")
    .Columns(columns =>
    {
        columns.Bound(c => c.ID_dv)
           .ClientTemplate("<input type='checkbox' class='chkbx' value='#= ID_dv #'/>")
           .HeaderTemplate("<input type='checkbox' id='masterCheckBox'/>")
           .Width(40)
           .Title("")
           .IncludeInMenu(false)
           .HeaderHtmlAttributes(new { style = "text-align:center" })
           .HtmlAttributes(new { style = "text-align:center" })
           .Filterable(false).Groupable(false).Sortable(false);
        columns.Bound(c => c.Ten_dv).Title("Tên dịch vụ");
        columns.Bound(c => c.Ten_rut_gon).Title("Tên rút gọn").Width(300);
        columns.Command(command => { command.Edit().Text("Sửa"); command.Destroy().Text("Xóa"); }).Width(200);
    })
    .ToolBar(toolBar =>
    {
        toolBar.Create().Text("Thêm dịch vụ");
        //toolBar.Custom().Text("Xóa các dịch vụ").Url("#").HtmlAttributes(new { onclick = "Delete()" });
        toolBar.Custom().Text("Đồng bộ dịch vụ").Url("#").HtmlAttributes(new { onclick = "Sync()" });
    })
    .Editable(edit =>
    {
        edit.DisplayDeleteConfirmation("Bạn có chắc bạn muốn xóa dịch vụ này không?");
        edit.Mode(GridEditMode.InLine);
    })
    .Pageable(pager => pager.PageSizes(new int[] { 5, 10, 20, 50, 100 }).Refresh(true).Input(true).Numeric(false).Messages(m => { m.ItemsPerPage("dòng mỗi trang"); m.First("Trang đầu tiên"); m.Last("Trang cuối cùng"); m.Next("Trang sau"); m.Previous("Trang trước"); m.Refresh("Làm mới"); }))
    .Sortable(s => s.SortMode(GridSortMode.SingleColumn))
    .Filterable()
    .Scrollable()
    .Groupable()
    .Resizable(r => r.Columns(true))
    .Reorderable(ro => ro.Columns(true))
    .Navigatable()
    //.ColumnMenu(menu => menu.Enabled(true).Sortable(false))
    //.Selectable(s => s.Mode(GridSelectionMode.Single))
.Events(e =>
    {
        e.DataBound("onDataBound");
    })
    .DataSource(
        dataSource => dataSource
            .Ajax()
            .Model(model =>
            {
                model.Id(p => p.ID_dv);
                model.Field(p => p.ID_dv).Editable(false);
            })
            .Read("GetWebServices", "MoodleWebService")
            .Create("CreateWebService", "MoodleWebService")
            .Update("UpdateWebService", "MoodleWebService")
            .Destroy("DeleteWebService", "MoodleWebService")
            .Events(e => e.Sync("gridRefresh").Error("onError"))
            .PageSize(50)
    )
)
<div>
    <button id="delete" class="k-button" onclick="Delete()">Xóa các dịch vụ</button>
    <button id="sync" class="k-button" onclick="Sync()" >Đồng bộ dịch vụ</button>
</div>
<script type="text/javascript">
    var selectedVals = [];

    function onError(e) {
        if (e.errors) {
            var message = "";
            $.each(e.errors, function (key, value) {
                if ('errors' in value) {
                    $.each(value.errors, function () {
                        message += this + "\n";
                    });
                }
            });

            showMessage("error", message, true, null);
        }
    }

    function loadGrid() {
        selectedVals.splice(0, selectedVals.length);
        gridRefresh();
    }
    // on data bound, check checkboxes
    function onDataBound(e) {
        checkCells(selectedVals, '#masterCheckBox', '#Grid :checkbox');
        resizeGrid("#Grid");
    }
    // on click checkbox cell in a row
    $(function () {
        $('#Grid').on('click', '.chkbx', function () {
            var state = $(this).is(':checked');
            var grid = $('#Grid').data().kendoGrid;
            var dataItem = grid.dataItem($(this).closest('tr'));

            checkVal(dataItem.ID_dv, state, selectedVals);
            $('#masterCheckBox').attr('checked', isCheckedAll('#Grid :checkbox'));
        })
    })
    $('#masterCheckBox').click(function () { checkAll(this, '#Grid :checkbox'); })

    function gridRefresh() {
        $("#Grid").data("kendoGrid").dataSource.read();
    }

    function Delete() {
        if (selectedVals.length == 0) {
            alert('Vui lòng chọn một dịch vụ!');
            return;
        }

        if (confirm('Bạn muốn xóa toàn bộ các dịch vụ đã chọn?')) {
            var action = '@Url.Action("DeleteWebServices","MoodleWebService")' + '/?selectedVals=' + selectedVals;
            processing(action, "Đang xóa các dịch vụ đã chọn...", gridRefresh);
        }
    }

    function Sync() {
        var action = '@Url.Action("SyncWebService","MoodleWebService")';
        processing(action, "Đang đồng bộ dịch vụ...", gridRefresh);
     }
</script>
