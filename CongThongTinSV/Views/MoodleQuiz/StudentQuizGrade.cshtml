@using CongThongTinSV.Models;
@using CongThongTinSV.App_Lib;

@{
    ViewBag.Title = ViewBag.FullName + " - " + ViewBag.CourseName;
    string heading = ViewBag.FullName + " (" + ViewBag.CourseName + ") - Điểm thi cũ: ";
}
@{
    if(ViewBag.Error != "")
    {
        <h2>@ViewBag.Title</h2>
        <h2 class="error">Lỗi: @ViewBag.Error</h2>
    }
    else
    {
        bool haveGrade = ViewBag.GradeID == 0 ? false : true;
        <h2 id="oldgrade">@heading@ViewBag.Grade</h2>
        @(Html.Kendo().Grid<CongThongTinSV.Models.MoodleStudentQuizGrade>()
            .Name("Grid")
            .Columns(columns =>
            {
                columns.Bound(c => c.ID).Title("Bài kiểm tra")
                    .ClientTemplate("<a href=#=Url# title='Tới trang làm bài'>#=QuizName#</a>")
                    .Width(500);
                columns.Bound(c => c.Grade)
                    .Width(70)
                    .ClientTemplate(
                        (@Html.ActionLink("#= kendo.toString(Grade, '0.0') #", "QuizStudentGrade", "MoodleQuiz", new { quizid = "QuizID" }, new { title = "Xem bảng điểm chi tiết" })).ToHtmlString().Replace("QuizID", "#=ID#"));
                columns.Command(command => command.Custom("Cập nhật điểm").Click("UpdateYGrade"))
                    .Visible(haveGrade);
            })
            .Pageable(pager => pager.PageSizes(new int[] { 5, 10, 20, 50 }).Refresh(true).Input(true).Numeric(false))
            .Sortable(s => s.SortMode(GridSortMode.SingleColumn))
            .Filterable()
            .Scrollable()
            //.Groupable()
            .Resizable(r => r.Columns(true))
            .Reorderable(ro => ro.Columns(true))
            .Navigatable()
            //.ColumnMenu(menu => menu.Enabled(true).Sortable(false))
            //.Selectable(s => s.Mode(GridSelectionMode.Single))
            .DataSource(
                dataSource => dataSource
                    .Ajax()
                    .Read(read => read.Action("GetStudentQuizGrades", "MoodleQuiz", new { courseid = ViewBag.CourseID , userid = ViewBag.UserID }))
                    .PageSize(50)
            )
        );
    }
}
<div style="text-align: center;margin-top: 10px;">
    <button class="k-button" type="submit" onclick="pageback()">Quay về danh sách các bài thi</button>
</div>
<script type ="text/javascript">
    function gradeRefresh() {
        //document.getElementById('oldgrade').innerHTML = '@heading@MoodleLib.GetYGradeString(ViewBag.UserID, ViewBag.CourseID)';
        window.location.reload(false);
    }

    function UpdateYGrade(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        if (confirm('Bạn muốn cập nhật điểm mới cho học viên này?')) {
            var action = '@Url.Action("UpdateYGrade","MoodleQuiz")' + '/?newgrade=' + dataItem.Grade + '&id_diem_thi=' + '@ViewBag.GradeID';
            processing(action, "Đang cập nhật điểm mới cho học viên...", gradeRefresh);
         }
    }
</script>