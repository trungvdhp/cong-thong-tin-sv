@using Kendo.Mvc.UI;
@using CongThongTinSV.Models;
@{
    ViewBag.Title = "Quản lý lớp học phần trên Moodle";
}

@(Html.Kendo().DropDownList()
    .Name("HocKy")
    .OptionLabel("Chọn học kỳ")
    .HtmlAttributes(new {style="width:180px"})
    .DataTextField("Text")
    .DataValueField("Value")
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("GetMoodleHocKy", "MoodleCategory");
        }).ServerFiltering(true);
    })
)

@(Html.Kendo().DropDownList()
    .Name("ChuyenNganh")
    .OptionLabel("Chọn chuyên ngành")
    .HtmlAttributes(new {style="width:260px"})
    .DataTextField("Text")
    .DataValueField("Value")
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("GetMoodleChuyenNganh", "MoodleCategory").Data("filterHocKy");
        }).ServerFiltering(true);
    })
    .Events(e =>
    {
        e.Change("loadGrid");
    })
    .Enable(false)
    .AutoBind(false)
        .CascadeFrom("HocKy")
)

@(Html.Kendo().Grid<CongThongTinSV.Models.MoodleLopTinChi>()
    .Name("Grid")
    .Columns(columns => {
        columns.Bound(c => c.ID)
            .ClientTemplate("<input type='checkbox' class='chkbx' value='#= ID #'/>")
            .HeaderTemplate("<input type='checkbox' id='masterCheckBox' onclick='checkAll(this)'/>")
            .Width(40)
            .Title("")
            .IncludeInMenu(false)
            .HeaderHtmlAttributes(new { style = "text-align:center" })
            .HtmlAttributes(new { style = "text-align:center" })
            .Filterable(false).Groupable(false).Sortable(false);
        columns.Bound(c => c.ID_moodle).Width(105);
        columns.Bound(c => c.Lop_hoc_phan);
        columns.Bound(c => c.Ky_hieu).Width(100);
        columns.Bound(c => c.So_tin_chi).Width(105).HtmlAttributes(new { style = "text-align:center" });
        columns.Bound(c => c.Tu_ngay).Width(120).Format("{0:dd-MM-yyyy}");
        columns.Bound(c => c.Den_ngay).Width(120).Format("{0:dd-MM-yyyy}");
    })
    .Pageable(pager => pager.PageSizes(new int[]{5, 10, 20, 50, 100, 300}).Refresh(true).Input(true).Numeric(false))
    .Sortable(s => s.SortMode(GridSortMode.MultipleColumn))
    .Filterable()
    .Scrollable()
    .Groupable()
    .Resizable(r => r.Columns(true))
    .Reorderable(ro => ro.Columns(true))
    .Navigatable()
    //.ColumnMenu(menu => menu.Enabled(true).Sortable(false))
    .Selectable(s => s.Mode(GridSelectionMode.Single))
    .Events(e => {
                e.DataBound("onDataBound");
            })
    .DataSource(
        dataSource => dataSource
            .Ajax()
            .Read(read => read.Action("GetLopTinChi", "MoodleCourse").Data("filterGrid"))
            .PageSize(50)
    )
)
<div>
    <button id="create">Tạo lớp</button>
    <button id="delete">Xóa lớp</button>
</div>
<script type="text/javascript">
    var selectedVals = [];

    function loadGrid() {
        selectedVals.splice(0, selectedVals.length);
        $("#Grid").data("kendoGrid").dataSource.read();
    }
    // on data bound, check checkboxes
    function onDataBound(e) {
        var ok = true;
        $('#Grid :checkbox').each(function () {
            var value = $(this).val()

            if (value != 'on') {
                var index = inArray(value, selectedVals);
                if (index >= 0) {
                    $(this).attr('checked', true);
                }
                else {
                    ok = false;
                }
            }
        });

        $('#masterCheckBox').attr('checked', ok);
    }

    function filterGrid() {
        return {
            id_chuyen_nganh: $("#ChuyenNganh").val()
        }
    }

    function filterHocKy() {
        return {
            ky_dang_ky: $("#HocKy").val()
        }
    }
    // on click checkbox cell in a row
    $(function () {
        $('#Grid').on('click', '.chkbx', function () {
            var state = $(this).is(':checked');
            var grid = $('#Grid').data().kendoGrid;
            var dataItem = grid.dataItem($(this).closest('tr'));

            check(dataItem.ID, state, selectedVals);
            $('#masterCheckBox').attr('checked', isCheckedAll());
        })
    })

    // return index of value in array
    // buils in function $.inArray not working in function check(value, state, array)
    function inArray(value, arr) {
        var len = arr.length;

        for (i = 0; i < len; i++) {
            if (value == arr[i])
                return i;
        }

        if (i == len) {
            return -1;
        }
    }
    // update value to array
    function check(value, state, array) {
        if (value != 'on') {
            var index = inArray(value, array);

            if (!state && index != -1) {
                // remove id from the list
                array.splice(index, 1);
            } else if (index == -1) {
                // add id to list
                array.push(value);
            }
        }
    }

    function checkAll(ele) {
        var state = $(ele).is(':checked');

        $('#Grid :checkbox').each(function () {
            check($(this).val(), state, selectedVals);
            $(this).attr('checked', state);
        });
    }

    function isCheckedAll() {
        var ok = true;

        $('#Grid :checkbox').each(function () {
            if ($(this).val() != 'on' && !$(this).is(':checked')) {
                ok = false;
            }
        });
        return ok;
    }
    function processing(action, mess) {
        $.blockUI({
            message: mess,
            css: {
                border: 'none',
                padding: '15px',
                backgroundColor: '#000',
                '-webkit-border-radius': '10px',
                '-moz-border-radius': '10px',
                opacity: .5,
                color: '#fff'
            }
        });

        $.ajax({
            url: action,
            //success: ,
            complete: function (e) {
                $("#Grid").data("kendoGrid").dataSource.read();
                $.unblockUI();
            },
            cache: false
        });
    }

    $("#create").click(function () {
        //window.location.href = '/MoodleCourse/CreateLopTinChi/?id_chuyen_nganh=' + jQuery("#ChuyenNganh").val() + '&selectedVals=' + selectedVals;
        processing('/MoodleCourse/CreateLopTinChi/?id_chuyen_nganh=' + jQuery("#ChuyenNganh").val() + '&selectedVals=' + selectedVals, "Đang tạo lớp học phần trên moodle...");
    })

    $("#delete").click(function () {
        if (confirm('Bạn muốn xóa toàn bộ các lớp học phần thuộc chuyên ngành đã chọn?')) {
            //window.location.href = '/MoodleCourse/DeleteLopTinChi/?id_chuyen_nganh=' + jQuery("#ChuyenNganh").val() + '&selectedVals=' + selectedVals;
            processing('/MoodleCourse/DeleteLopTinChi/?id_chuyen_nganh=' + jQuery("#ChuyenNganh").val() + '&selectedVals=' + selectedVals, "Đang xóa lớp học phần trên moodle...");
        }
    })
</script>