@using Kendo.Mvc.UI;
@using CongThongTinSV.Models;
@{
    ViewBag.Title = "InDanhSachLop";
}


@*@Html.Label("NamHoc", "Năm học:")*@
@(Html.Kendo().DropDownList()
    .Name("NamHoc")
    .OptionLabel("Chọn năm học")
    .HtmlAttributes(new {style="width:120px"})
    .DataTextField("Text")
    .DataValueField("Value")
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("GetNamHoc", "JSON");
        }).ServerFiltering(true);
    })
)

@*@Html.Label("HocKy", "Học kỳ:")*@
@(Html.Kendo().DropDownList()
    .Name("HocKy")
    .HtmlAttributes(new {style="width:120px"})
    .OptionLabel("Chọn học kỳ")
    .DataTextField("Text")
    .DataValueField("Value")
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("GetHocKy", "JSON")
                .Data("filterHocKy");
        }).ServerFiltering(true);
    })
    .Enable(false)
    .AutoBind(false)
        .CascadeFrom("NamHoc")
)
@*@Html.Label("DotHoc", "Đợt học:")*@
@(Html.Kendo().DropDownList()
    .Name("DotHoc")
    .OptionLabel("Chọn đợt học")
    .HtmlAttributes(new {style="width:120px"})
    .DataTextField("Text")
    .DataValueField("Value")
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("GetDotHoc", "JSON")
                .Data("filterDotHoc");
        }).ServerFiltering(true);
    })
    .Enable(false)
    .AutoBind(false)
        .CascadeFrom("HocKy")
)
@*@Html.Label("HeDT", "Hệ đào tạo:")*@
@(Html.Kendo().DropDownList()
    .Name("HeDT")
    .OptionLabel("Chọn hệ đào tạo")
    .DataTextField("Text")
    .DataValueField("Value")
        .SelectedIndex(0)
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("GetHeDT", "JSON");
        }).ServerFiltering(true);
    })
    .CascadeFrom("DotHoc")
)
@*@Html.Label("Khoa", "Khoa:")*@
@(Html.Kendo().DropDownList()
    .Name("Khoa")
    .HtmlAttributes(new {style="width:200px"})
    .OptionLabel("Chọn khoa")
    .DataTextField("Text")
    .DataValueField("Value")
        .SelectedIndex(0)
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("GetKhoa", "JSON");
        }).ServerFiltering(true);
    })
    .CascadeFrom("HeDT")
)
@*@Html.Label("KhoaHoc", "Khóa:")*@
@(Html.Kendo().DropDownList()
    .Name("KhoaHoc")
    .HtmlAttributes(new {style="width:120px"})
    .OptionLabel("Chọn khóa học")
    .DataTextField("Text")
    .DataValueField("Value")
        .SelectedIndex(0)
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("GetKhoaHoc", "JSON");
        }).ServerFiltering(true);
    })
    .CascadeFrom("Khoa")
)
@*@Html.Label("LopTC", "Danh sách lớp học phần:")*@
@(Html.Kendo().DropDownList()
    .Name("LopTC")
    .HtmlAttributes(new {style="width:300px"})
    .OptionLabel("Chọn lớp học phần")
    .DataTextField("Text")
    .DataValueField("Value")
        //.SelectedIndex(0)
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("GetLopTC", "JSON")
                .Data("filterLopTC");
        }).ServerFiltering(true);
    })
    .Enable(false)
    .AutoBind(false)
        .CascadeFrom("KhoaHoc")
    .Events(e=>{
        e.Change("loadGridSinhVien");
    })
)
@(Html.Kendo().Grid<CongThongTinSV.Models.SinhVien>()
    .Name("GridSinhVien")
    .Columns(columns => {
        columns.Bound(sv => sv.ID_sv).Groupable(false)
            .ClientTemplate("<input type='checkbox'  class='chkbx' value='#= ID_sv #'/>")
            .HeaderTemplate("<input type='checkbox' id='masterCheckBox' onclick='checkAll(this)'/>").Width(200)
            .Title("")
            .Width(36)
            .HtmlAttributes(new { style = "text-align:center" })
            .Filterable(false).Groupable(false).Sortable(false);
        columns.Bound(sv => sv.Ma_sv);
        columns.Bound(sv => sv.Ho_ten);
        columns.Bound(sv => sv.Lop);
    })
    .Pageable()
    .Sortable()
    .Filterable()
    .Scrollable()
    .Groupable()
    .Events(e => {
                e.DataBound("onDataBound");
            })
    .DataSource(
        dataSource => dataSource
            .Ajax()
            .Read(read => read.Action("GetSinhVienLopTC", "JSON").Data("filterGrid"))
            
    )
)

<script type="text/javascript">
    // this object will store all checked records
    var selected = Array();
    $(function () {
        $('#GridSinhVien').on('click', '.chkbx', function () {
            var checked = $(this).is(':checked');
            var grid = $('#GridSinhVien').data().kendoGrid;
            var dataItem = grid.dataItem($(this).closest('tr'));
            selected[dataItem.ID_sv] = checked;
            $("#masterCheckBox").attr('checked', isCheckedAll());
        })
    })
    function isCheckedAll() {
        var check = true;
        $('#GridSinhVien :checkbox').each(function () {
            if ($(this).val()!='on' && !$(this).is(":checked")) check = false;
        });
        return check;
    }
    function checkAll(ele) {
        var state = $(ele).is(':checked');
        var grid = $('#GridSinhVien').data().kendoGrid;
        $('#GridSinhVien :checkbox').each(function () {
            selected[$(this).val()] = state;
            $(this).attr('checked', state);
        });
    }
    function onDataBound(e) {
        $('#GridSinhVien :checkbox').each(function () {
            if (selected[$(this).val()]) $(this).attr('checked', true);
        });
        $("#masterCheckBox").attr('checked', isCheckedAll());
    }
    function filterHocKy() {
        return {
            NamHoc: $("#NamHoc").val()
        }
    }
    function filterDotHoc() {
        return {
            NamHoc: $("#NamHoc").val(),
            HocKy: $("#HocKy").val()
        }
    }
    function filterGrid() {
        return {
            ID_lop_tc: $("#LopTC").val()
        }
    }
    function GridSinhVien_DataBound(e) {
        alert(e.row);
    }
    function filterLopTC() {
        return {
            Ky_dang_ky: $("#DotHoc").val(),
            ID_khoa: $("#Khoa").val(),
            ID_he: $("#HeDT").val(),
            Khoa_hoc: $("#KhoaHoc").val(),
        }
    }
    function loadGridSinhVien() {
        selected = Array();
        $("#GridSinhVien").data("kendoGrid").dataSource.read();
    }
</script>